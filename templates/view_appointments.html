{% extends "base.html" %}

{% block title %}Select Appointment Time Slot{% endblock %}

{% block content %}
<div class="appointment-page-wrapper py-5" style="min-height: 100vh; background-image: url('{{ url_for('static', filename='images/background.jpg') }}'); background-size: cover; background-position: center; background-attachment: fixed;">

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-9">

                <div class="appointment-card p-4 p-md-5 border rounded shadow-lg"
                     style="background-color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">

                    <a href="{{ url_for('request_appointment') }}" class="back-link mb-4 d-inline-block"
                       style="color: #4b0082; font-weight: 600; text-decoration: none;">
                        &larr; Change Location/Service
                    </a>

                    <h2 class="text-center mb-3" style="color: #4169E1; font-weight: 700;">Select Date & Time Slot</h2>
                    <p class="text-center mb-5 fw-bold" style="color: #6A5ACD; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                        Booking for: **{{ location }}** | Service: **{{ service_type|capitalize }}**
                    </p>

                    <form method="POST" action="{{ url_for('appointment_review') }}" id="slot-form">

                        <div class="mb-4">
                            <label for="therapist_select" class="form-label fw-bold" style="color: #4b0082;">Select Therapist:</label>
                            <select id="therapist_select" name="therapist" class="form-select form-select-lg" required
                                    style="border: 1px solid #ddd; border-radius: 8px;">
                                <option value="" disabled selected>Select a mental health professional</option>
                                {% for therapist in available_therapists %}
                                    <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="appointment_date" class="form-label fw-bold" style="color: #4b0082;">Select Date:</label>
                            <input type="date"
                                   id="appointment_date"
                                   name="date"
                                   class="form-control form-control-lg"
                                   required
                                   min="{{ min_date }}"
                                   max="{{ max_date }}"
                                   onchange="fetchAvailableSlots(this.value)"
                                   style="width: 100%; border-radius: 8px;">
                            <div class="text-muted small mt-2">Bookings available from **{{ min_date }}** to **{{ max_date }}**.</div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold" style="color: #4b0082;">Available Times:</label>
                            <div id="time_slots_container" class="slot-scroll-area p-3 border rounded" style="max-height: 250px; overflow-y: auto; background-color: #f7f7ff; border-color: #e0e0f0;">

                                <h5 class="slot-header mt-1 mb-3 text-muted">Initial Slots Available (Select Date to Refresh)</h5>

                                <div class="d-flex flex-wrap gap-2 mb-4">
                                    {% if time_slots_for_today %}
                                        {% for slot in time_slots_for_today %}
                                            <button type="button"
                                                    class="slot-btn btn btn-sm"
                                                    data-time="{{ slot }}"
                                                    onclick="selectTime(this)">
                                                {{ slot }}
                                            </button>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-info">Please select a date above to see real-time available slots.</p>
                                    {% endif %}
                                </div>
                            </div>
                            <input type="hidden" id="selected_time" name="time" required>
                        </div>

                        <div class="mb-5">
                            <label for="appointment_note" class="form-label fw-bold" style="color: #4b0082;">Note (Optional):</label>
                            <textarea id="appointment_note" name="note" class="form-control" rows="3" placeholder="I prefer to discuss anxiety..." style="border-radius: 8px;"></textarea>
                        </div>

                        <div class="mt-4 pt-4 border-top text-center">
                            <button type="submit"
                               class="btn btn-lg w-75 fw-bold"
                               id="review_button"
                               disabled
                               style="background: linear-gradient(to right, #6A5ACD, #4169E1); color: white; border: none; border-radius: 30px; padding: 12px 25px; transition: all 0.3s ease; opacity: 0.5;">
                                Review Appointment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Base button styles */
.slot-btn {
    background-color: #ffffff;
    color: #333;
    border: 1px solid #c0c0e0; /* Lighter border for contrast */
    border-radius: 5px;
    padding: 8px 15px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Subtle shadow */
}

/* Hover effect */
.slot-btn:hover:not(.slot-selected) {
    background-color: #e6e6fa; /* Lavender background */
    border-color: #6A5ACD;
    transform: translateY(-1px);
}

/* Selected slot styling */
.slot-selected {
    background: linear-gradient(to right, #6A5ACD, #4169E1);
    color: white;
    border-color: #4169E1;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* Disabled button style */
#review_button[disabled] {
    cursor: not-allowed;
    opacity: 0.5 !important;
}
#review_button:not([disabled]):hover {
    box-shadow: 0 4px 15px rgba(65, 105, 225, 0.5); /* Shadow on active hover */
}
</style>

<script>
    const form = document.getElementById('slot-form');
    const selectedTimeInput = document.getElementById('selected_time');
    const reviewButton = document.getElementById('review_button');
    const dateInput = document.getElementById('appointment_date');
    const therapistSelect = document.getElementById('therapist_select');

    // Define the mock time slots within the JavaScript for re-use
    const MOCK_TIME_SLOTS = ["10:00 AM", "11:30 AM", "2:00 PM", "4:30 PM", "6:00 PM", "7:00 PM"];

    function checkFormValidity() {
        const isValid = dateInput.value && therapistSelect.value && selectedTimeInput.value;
        reviewButton.disabled = !isValid;
        reviewButton.style.opacity = isValid ? '1' : '0.5';
    }

    function selectTime(button) {
        document.querySelectorAll('.slot-btn').forEach(btn => {
            btn.classList.remove('slot-selected');
        });

        button.classList.add('slot-selected');
        selectedTimeInput.value = button.getAttribute('data-time');
        checkFormValidity();
    }

    function fetchAvailableSlots(selectedDate) {
        // Clear previous time selection
        selectedTimeInput.value = '';

        const container = document.getElementById('time_slots_container');

        // --- START: FIX FOR RENDERING SLOTS ---

        let html = `
            <h5 class="slot-header mt-1 mb-3" style="color:#5d5dff;">Available Slots for ${selectedDate}</h5>
            <div class="d-flex flex-wrap gap-2 mb-4">
        `;

        // 1. Loop through the mock slots and create buttons
        MOCK_TIME_SLOTS.forEach(slot => {
            html += `
                <button type="button"
                        class="slot-btn btn btn-sm"
                        data-time="${slot}"
                        onclick="selectTime(this)">
                    ${slot}
                </button>
            `;
        });

        html += `</div>`;

        // 2. Inject the new HTML content
        container.innerHTML = html;

        // --- END: FIX FOR RENDERING SLOTS ---

        checkFormValidity();
    }

    // Event listeners to check validity upon change
    dateInput.addEventListener('change', checkFormValidity);
    therapistSelect.addEventListener('change', checkFormValidity);

    // Initial check on load
    document.addEventListener('DOMContentLoaded', checkFormValidity);
</script>
{% endblock %}